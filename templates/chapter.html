{% extends 'base.html' %}
{% block title %}{{ chapter.title }} - {{ chapter.novel.title }} - TaleTap{% endblock %}
{% block meta_description %}Read {{ chapter.title }} from {{ chapter.novel.title }} on TaleTap. Enjoy this {{ chapter.novel.category.lower() }} story for free.{% endblock %}
{% block meta_keywords %}{{ chapter.novel.title }}, {{ chapter.title }}, {{ chapter.novel.category.lower() }} novel, free reading, online novel{% endblock %}

{% block head %}
<meta name="description" content="Read {{ chapter.title }} of {{ chapter.novel.title }} for free. Enjoy epic {{ chapter.novel.category.lower() }} adventures on TaleTap!">
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "CreativeWork",
    "name": "{{ chapter.title }}",
    "author": {
        "@type": "Person",
        "name": "TaleTap Author"
    },
    "isPartOf": {
        "@type": "Book",
        "name": "{{ chapter.novel.title }}",
        "genre": "{{ chapter.novel.category }}",
        "description": "{{ chapter.novel.description[:200] }}"
    },
    "description": "{{ chapter.content[:200] | striptags }}",
    "url": "https://taletap.org/novel/{{ chapter.novel_id }}/chapter/{{ chapter.id }}",
    "datePublished": "{{ chapter.created_at.strftime('%Y-%m-%d') if chapter.created_at else '2024-01-01' }}",
    "publisher": {
        "@type": "Organization",
        "name": "TaleTap",
        "url": "https://taletap.org"
    }
}
</script>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Breadcrumb Navigation -->
    <nav class="text-sm text-gray-600 dark:text-gray-400 mb-6" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-2">
            <li><a href="{{ url_for('index') }}" class="hover:text-primary-600 dark:hover:text-primary-400">Home</a></li>
            <li><span class="mx-2">/</span></li>
            <li><a href="{{ url_for('novel', novel_id=chapter.novel.id) }}" class="hover:text-primary-600 dark:hover:text-primary-400">{{ chapter.novel.title }}</a></li>
            <li><span class="mx-2">/</span></li>
            <li class="text-gray-900 dark:text-gray-100">{{ chapter.title }}</li>
        </ol>
    </nav>

    <!-- Chapter Header -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">{{ chapter.title }}</h1>
                <p class="text-gray-600 dark:text-gray-300">From: <a href="{{ url_for('novel', novel_id=chapter.novel.id) }}" class="text-primary-600 dark:text-primary-400 hover:underline">{{ chapter.novel.title }}</a></p>
            </div>
            {% if chapter.novel.category %}
            <span class="px-3 py-1 text-sm font-semibold text-white bg-primary-600 rounded-full">
                {{ chapter.novel.category }}
            </span>
            {% endif %}
        </div>

        <!-- Reading Controls -->
        <div class="flex items-center justify-between flex-wrap gap-4">
            <div class="flex items-center space-x-4">
                <button id="font-size-decrease" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Decrease font size">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                    </svg>
                </button>
                <span id="font-size-display" class="text-sm font-medium">18px</span>
                <button id="font-size-increase" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Increase font size">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                </button>
            </div>

            <div class="flex items-center space-x-2">
                <button id="toggle-dark-mode" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Toggle dark mode">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                    </svg>
                </button>
                <button id="toggle-fullscreen" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Toggle fullscreen">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- AdSense Top Banner -->
    <div class="ad-container mb-8">
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2786216806192691"
             crossorigin="anonymous"></script>
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-2786216806192691"
             data-ad-slot="1234567890"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>

    <!-- Chapter Content -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 mb-8">
        <div id="chapter-content" class="chapter-content prose prose-lg max-w-none dark:prose-invert">
            {{ chapter.content | safe }}
        </div>
    </div>

    <!-- AdSense In-Article -->
    <div class="ad-container mb-8">
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2786216806192691"
             crossorigin="anonymous"></script>
        <ins class="adsbygoogle"
             style="display:block; text-align:center;"
             data-ad-layout="in-article"
             data-ad-format="fluid"
             data-ad-client="ca-pub-2786216806192691"
             data-ad-slot="5513655241"></ins>
        <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>

    <!-- Navigation -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
        <div class="flex justify-between items-center">
            {% if prev_chapter_id %}
                <a href="{{ url_for('chapter', novel_id=novel_id, chapter_id=prev_chapter_id) }}" 
                   class="inline-flex items-center px-6 py-3 text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 rounded-lg transition-colors">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                    Previous Chapter
                </a>
            {% else %}
                <span class="inline-flex items-center px-6 py-3 text-sm font-medium text-gray-400 bg-gray-100 dark:bg-gray-700 rounded-lg">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                    No Previous Chapter
                </span>
            {% endif %}

            <a href="{{ url_for('novel', novel_id=chapter.novel.id) }}" 
               class="inline-flex items-center px-6 py-3 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-colors">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                </svg>
                Back to Novel
            </a>

            {% if next_chapter_id %}
                <a href="{{ url_for('chapter', novel_id=novel_id, chapter_id=next_chapter_id) }}" 
                   class="inline-flex items-center px-6 py-3 text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 rounded-lg transition-colors">
                    Next Chapter
                    <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </a>
            {% else %}
                <span class="inline-flex items-center px-6 py-3 text-sm font-medium text-gray-400 bg-gray-100 dark:bg-gray-700 rounded-lg">
                    No Next Chapter
                    <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </span>
            {% endif %}
        </div>
    </div>

    <!-- Related Novels -->
    {% if related_novels %}
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">You Might Also Like</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            {% for novel in related_novels[:3] %}
            <a href="{{ url_for('novel', novel_id=novel.id) }}" class="group block">
                <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    <h4 class="font-semibold text-gray-900 dark:text-white group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors">
                        {{ novel.title }}
                    </h4>
                    <p class="text-sm text-gray-600 dark:text-gray-300 mt-1 line-clamp-2">
                        {{ novel.description[:100] }}...
                    </p>
                    {% if novel.category %}
                    <span class="inline-block mt-2 px-2 py-1 text-xs font-medium text-white bg-primary-600 rounded">
                        {{ novel.category }}
                    </span>
                    {% endif %}
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Comments Section -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Comments</h3>
        
        {% if current_user.is_authenticated %}
        <form method="POST" action="{{ url_for('add_comment', chapter_id=chapter.id) }}" class="mb-6">
            {{ form.hidden_tag() }}
            <div class="mb-4">
                <label for="{{ form.content.id }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Share your thoughts
                </label>
                {{ form.content(class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent", rows="3", placeholder="What did you think of this chapter?") }}
            </div>
            <div class="flex justify-end">
                {{ form.submit(class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors font-medium") }}
            </div>
        </form>
        {% else %}
        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6">
            <p class="text-blue-800 dark:text-blue-200">
                <a href="{{ url_for('login') }}" class="font-medium underline hover:no-underline">Login</a> to join the discussion and share your thoughts on this chapter.
            </p>
        </div>
        {% endif %}

        {% if chapter.comments %}
        <div class="space-y-4">
            {% for comment in chapter.comments %}
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-primary-500 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm font-medium">{{ comment.user.username[0].upper() }}</span>
                        </div>
                        <span class="font-medium text-gray-900 dark:text-white">{{ comment.user.username }}</span>
                    </div>
                    <span class="text-sm text-gray-500 dark:text-gray-400">{{ comment.timestamp.strftime('%B %d, %Y') }}</span>
                </div>
                <p class="text-gray-700 dark:text-gray-300">{{ comment.content }}</p>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8 text-gray-500 dark:text-gray-400">
            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
            <p>Be the first to comment on this chapter!</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Reading progress bar
const progressBar = document.getElementById('reading-progress');
window.addEventListener('scroll', function() {
    const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
    const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    const scrolled = (winScroll / height) * 100;
    progressBar.style.width = scrolled + '%';
});

// Font size controls
let currentFontSize = 18;
const content = document.getElementById('chapter-content');
const fontSizeDisplay = document.getElementById('font-size-display');

document.getElementById('font-size-increase').addEventListener('click', function() {
    if (currentFontSize < 24) {
        currentFontSize += 2;
        content.style.fontSize = currentFontSize + 'px';
        fontSizeDisplay.textContent = currentFontSize + 'px';
        localStorage.setItem('fontSize', currentFontSize);
    }
});

document.getElementById('font-size-decrease').addEventListener('click', function() {
    if (currentFontSize > 14) {
        currentFontSize -= 2;
        content.style.fontSize = currentFontSize + 'px';
        fontSizeDisplay.textContent = currentFontSize + 'px';
        localStorage.setItem('fontSize', currentFontSize);
    }
});

// Load saved font size
const savedFontSize = localStorage.getItem('fontSize');
if (savedFontSize) {
    currentFontSize = parseInt(savedFontSize);
    content.style.fontSize = currentFontSize + 'px';
    fontSizeDisplay.textContent = currentFontSize + 'px';
}

// Fullscreen toggle
document.getElementById('toggle-fullscreen').addEventListener('click', function() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
    } else {
        document.exitFullscreen();
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft' && document.getElementById('prev-chapter')) {
        document.getElementById('prev-chapter').click();
    } else if (e.key === 'ArrowRight' && document.getElementById('next-chapter')) {
        document.getElementById('next-chapter').click();
    }
});
</script>
{% endblock %}