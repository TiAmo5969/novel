{% extends 'base.html' %}
{% block title %}{{ title }}{% endblock %}

{% block head %}
<style>
    .section-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        margin-bottom: 24px;
        overflow: hidden;
    }

    .dark .section-card {
        background: #1f2937;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    }

    .section-header {
        padding: 24px 24px 0 24px;
    }

    .section-title {
        font-size: 20px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 8px;
    }

    .dark .section-title {
        color: #f9fafb;
    }

    .section-content {
        padding: 24px;
    }

    .upload-zone {
        border: 2px dashed #d1d5db;
        border-radius: 12px;
        padding: 48px 24px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .upload-zone:hover {
        border-color: #3b82f6;
        background: #f8fafc;
    }

    .dark .upload-zone {
        border-color: #4b5563;
        background: #374151;
    }

    .dark .upload-zone:hover {
        border-color: #3b82f6;
        background: #4b5563;
    }

    .upload-icon {
        width: 48px;
        height: 48px;
        color: #9ca3af;
        margin: 0 auto 16px;
    }

    .upload-text {
        color: #6b7280;
    }

    .dark .upload-text {
        color: #9ca3af;
    }

    .upload-main-text {
        font-size: 18px;
        font-weight: 500;
        margin-bottom: 4px;
    }

    .upload-sub-text {
        font-size: 14px;
    }

    .config-card {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 20px;
    }

    .dark .config-card {
        background: #374151;
        border-color: #4b5563;
    }

    .config-title {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 16px;
    }

    .dark .config-title {
        color: #f9fafb;
    }

    .step-indicator {
        display: flex;
        flex-direction: column;
        align-items: center;
        opacity: 0.5;
        transition: all 0.3s ease;
    }

    .step-indicator.step-active {
        opacity: 1;
    }

    .step-indicator.step-completed {
        opacity: 1;
        color: #10b981;
    }

    .step-number {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
        color: #6b7280;
        margin-bottom: 8px;
    }

    .step-indicator.step-active .step-number {
        background: #3b82f6;
        color: white;
    }

    .step-indicator.step-completed .step-number {
        background: #10b981;
        color: white;
    }

    .step-label {
        font-size: 12px;
        font-weight: 500;
        text-align: center;
        color: #6b7280;
    }

    .step-indicator.step-active .step-label {
        color: #3b82f6;
    }

    .step-indicator.step-completed .step-label {
        color: #10b981;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .info-item {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
    }

    .dark .info-item {
        background: #374151;
        border-color: #4b5563;
    }

    .info-label {
        font-size: 12px;
        font-weight: 500;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 4px;
    }

    .info-value {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
    }

    .dark .info-value {
        color: #f9fafb;
    }

    .log-entry {
        padding: 8px 12px;
        margin-bottom: 4px;
        border-radius: 6px;
        font-size: 14px;
        font-family: 'Courier New', monospace;
    }

    .log-info {
        background: #eff6ff;
        color: #1e40af;
        border-left: 3px solid #3b82f6;
    }

    .dark .log-info {
        background: #1e3a8a;
        color: #93c5fd;
    }

    .log-success {
        background: #f0fdf4;
        color: #166534;
        border-left: 3px solid #10b981;
    }

    .dark .log-success {
        background: #064e3b;
        color: #6ee7b7;
    }

    .log-error {
        background: #fef2f2;
        color: #dc2626;
        border-left: 3px solid #ef4444;
    }

    .dark .log-error {
        background: #7f1d1d;
        color: #fca5a5;
    }

    .mode-tabs {
        display: flex;
        background: #f3f4f6;
        border-radius: 8px;
        padding: 4px;
        margin-bottom: 24px;
    }

    .dark .mode-tabs {
        background: #374151;
    }

    .mode-tab {
        flex: 1;
        padding: 12px 24px;
        text-align: center;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        color: #6b7280;
    }

    .dark .mode-tab {
        color: #9ca3af;
    }

    .mode-tab.active {
        background: white;
        color: #1f2937;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .dark     .mode-tab.active {
        background: #1f2937;
        color: #f9fafb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .status-item {
        text-align: center;
        padding: 16px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
    }

    .dark .status-item {
        background: #374151;
        border-color: #4b5563;
    }

    .status-label {
        font-size: 12px;
        font-weight: 500;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 4px;
    }

    .dark .status-label {
        color: #9ca3af;
    }

    .status-value {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
    }

    .dark .status-value {
        color: #f9fafb;
    }

    .progress-card {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
    }

    .dark .progress-card {
        background: #374151;
        border-color: #4b5563;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
    <!-- È°µÈù¢Ê†áÈ¢ò -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
            üìñ {{ title }} - {{ novel.title }}
        </h1>
        <p class="text-gray-600 dark:text-gray-400">
            ‰∏∫Â∞èËØ¥„Ää{{ novel.title }}„ÄãÊ∑ªÂä†Á´†ËäÇÔºåÊîØÊåÅÂçïÁ´†ËäÇÊ∑ªÂä†ÊàñÊâπÈáèÁøªËØëÊ∑ªÂä†
        </p>
    </div>

    <!-- Ê®°ÂºèÈÄâÊã©Ê†áÁ≠æ -->
    <div class="mode-tabs">
        <div class="mode-tab active" id="single-mode-tab" onclick="switchMode('single')">
            üìù ÂçïÁ´†ËäÇÊ∑ªÂä†
        </div>
        <div class="mode-tab" id="batch-mode-tab" onclick="switchMode('batch')">
            üîÑ ÊâπÈáèÁøªËØëÊ∑ªÂä†
        </div>
    </div>

    <!-- ÂçïÁ´†ËäÇÊ∑ªÂä†Ê®°Âºè -->
    <div id="single-mode" class="mode-content">
        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">üìù ÂçïÁ´†ËäÇÊ∑ªÂä†</h2>
            </div>
            <div class="section-content">
                <form method="POST" id="single-form">
                    {{ form.hidden_tag() }}
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Á´†ËäÇÊ†áÈ¢ò <span class="text-red-500">*</span>
                            </label>
                            {{ form.title(class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent") }}
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Á´†ËäÇÂÜÖÂÆπ <span class="text-red-500">*</span>
                            </label>
                            {{ form.content(class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent", rows="10") }}
                        </div>
                        <div class="flex justify-end">
                            {{ form.submit(class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors") }}
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ÊâπÈáèÁøªËØëÊ∑ªÂä†Ê®°Âºè -->
    <div id="batch-mode" class="mode-content hidden">
        <!-- Ê≠•È™§ÊåáÁ§∫Âô® -->
        <div class="mb-8">
            <div class="flex items-center justify-between relative">
                <div class="flex items-center">
                    <div id="step-1-indicator" class="step-indicator step-active">
                        <div class="step-number">1</div>
                        <div class="step-label">‰∏ä‰º†Êñá‰ª∂</div>
                    </div>
                </div>
                
                <div class="flex-1 h-1 bg-gray-200 dark:bg-gray-700 mx-4">
                    <div id="progress-bar-1" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                </div>
                
                <div class="flex items-center">
                    <div id="step-2-indicator" class="step-indicator">
                        <div class="step-number">2</div>
                        <div class="step-label">Ëß£ÊûêÁ´†ËäÇ</div>
                    </div>
                </div>
                
                <div class="flex-1 h-1 bg-gray-200 dark:bg-gray-700 mx-4">
                    <div id="progress-bar-2" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                </div>
                
                <div class="flex items-center">
                    <div id="step-3-indicator" class="step-indicator">
                        <div class="step-number">3</div>
                        <div class="step-label">AIÁøªËØë</div>
                    </div>
                </div>
                
                <div class="flex-1 h-1 bg-gray-200 dark:bg-gray-700 mx-4">
                    <div id="progress-bar-3" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                </div>
                
                <div class="flex items-center">
                    <div id="step-4-indicator" class="step-indicator">
                        <div class="step-number">4</div>
                        <div class="step-label">ÂÆåÊàê</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ê≠•È™§1: Êñá‰ª∂‰∏ä‰º† -->
        <div id="upload-section" class="section-card">
            <div class="section-header">
                <h2 class="section-title">üìÅ ‰∏ä‰º†‰∏≠ÊñáÂ∞èËØ¥Êñá‰ª∂</h2>
            </div>
            <div class="section-content">
                <!-- Êñá‰ª∂‰∏ä‰º†Âå∫Âüü -->
                <div class="upload-zone" id="upload-zone" onclick="document.getElementById('novel-file').click()">
                    <div class="upload-content">
                        <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <div class="upload-text">
                            <div class="upload-main-text">ÁÇπÂáª‰∏ä‰º†ÊàñÊãñÊãΩÊñá‰ª∂Âà∞Ê≠§Â§Ñ</div>
                            <div class="upload-sub-text">ÊîØÊåÅ TXT Ê†ºÂºèÔºåÂåÖÂê´Â§öÁ´†ËäÇÁöÑ‰∏≠ÊñáÂ∞èËØ¥</div>
                        </div>
                    </div>
                    <input type="file" id="novel-file" accept=".txt" style="display: none;" onchange="handleFileSelect(this)">
                </div>

                <!-- Êñá‰ª∂‰ø°ÊÅØÊòæÁ§∫ -->
                <div id="file-info" class="hidden mt-4 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 rounded-lg">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div>
                            <div class="font-medium text-green-800 dark:text-green-200">Êñá‰ª∂Â∑≤ÈÄâÊã©</div>
                            <div class="text-sm text-green-600 dark:text-green-300">
                                <span id="file-name"></span> - <span id="file-size"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÈÖçÁΩÆÂå∫Âüü -->
                <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- API KeyÈÖçÁΩÆ -->
                    <div class="config-card">
                        <h3 class="config-title">üîë APIÈÖçÁΩÆ</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    ÈÄö‰πâÂçÉÈóÆAPI Key
                                </label>
                                <input type="password" id="api-key" 
                                       class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"
                                       placeholder="ÁïôÁ©∫‰ΩøÁî®ÈªòËÆ§APIÂØÜÈí•">
                                <div class="text-xs text-gray-500 mt-1">
                                    üîó <a href="https://dashscope.console.aliyun.com/" target="_blank" class="text-blue-600 underline">Ëé∑ÂèñAPI Key</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÁøªËØëÈÖçÁΩÆ -->
                    <div class="config-card">
                        <h3 class="config-title">‚öôÔ∏è ÁøªËØëÈÖçÁΩÆ</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" id="use-custom-prompt" class="mr-2" onchange="toggleCustomPrompt()">
                                    <span class="font-medium text-gray-700 dark:text-gray-300">‰ΩøÁî®Ëá™ÂÆö‰πâÊèêÁ§∫ËØç</span>
                                </label>
                            </div>
                            
                            <div id="custom-prompt-section" class="hidden">
                                <textarea id="custom-prompt" 
                                          class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"
                                          rows="3" 
                                          placeholder="ËæìÂÖ•Ëá™ÂÆö‰πâÁøªËØëÊèêÁ§∫ËØç..."></textarea>
                            </div>
                            
                            <div>
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" id="preview-mode" class="mr-2">
                                    <span class="font-medium text-gray-700 dark:text-gray-300">È¢ÑËßàÊ®°Âºè (Âè™ÁøªËØëÂâç3Á´†)</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÂºÄÂßãËß£ÊûêÊåâÈíÆ -->
                <div class="mt-6">
                    <button id="analyze-btn" onclick="startAnalysis()" disabled
                            class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                        ÂºÄÂßãËß£ÊûêÂ∞èËØ¥
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Ê≠•È™§2: Ëß£ÊûêÁªìÊûú -->
        <div id="parse-section" class="section-card hidden">
            <div class="section-header">
                <h2 class="section-title">üìä Ëß£ÊûêÁªìÊûú</h2>
            </div>
            <div class="section-content">
                <!-- Â∞èËØ¥Âü∫Êú¨‰ø°ÊÅØ -->
                <div id="novel-info" class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Ê†áÈ¢ò</div>
                        <div id="novel-title" class="info-value"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">‰ΩúËÄÖ</div>
                        <div id="novel-author" class="info-value"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ÂàÜÁ±ª</div>
                        <div id="novel-category" class="info-value"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Á´†ËäÇÊï∞</div>
                        <div id="chapter-count" class="info-value"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ÊÄªÂ≠óÊï∞</div>
                        <div id="total-words" class="info-value"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">È¢Ñ‰º∞ÊàêÊú¨</div>
                        <div id="estimated-cost" class="info-value text-orange-600"></div>
                    </div>
                </div>

                <!-- Á´†ËäÇÈ¢ÑËßà -->
                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">üìñ Á´†ËäÇÈ¢ÑËßà</h3>
                    <div id="chapters-preview" class="space-y-3"></div>
                </div>

                <!-- ÂºÄÂßãÁøªËØëÊåâÈíÆ -->
                <div class="mt-6">
                    <button id="translate-btn" onclick="startTranslation()" disabled
                            class="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                        ÂºÄÂßãÁøªËØëÁ´†ËäÇ
                    </button>
                </div>
            </div>
        </div>

        <!-- Ê≠•È™§3: ÁøªËØëËøõÂ∫¶ -->
        <div id="translate-section" class="section-card hidden">
            <div class="section-header">
                <h2 class="section-title">ü§ñ AIÁøªËØëËøõË°å‰∏≠</h2>
            </div>
            <div class="section-content">
                <!-- ÊÄª‰ΩìËøõÂ∫¶ -->
                <div class="progress-card">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">ÁøªËØëËøõÂ∫¶</span>
                        <span id="progress-percent" class="text-sm font-medium text-blue-600">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                        <div id="progress-bar" class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div class="mt-2 text-xs text-gray-500">
                        <span id="progress-text">ÂáÜÂ§áÂºÄÂßã...</span>
                    </div>
                </div>

                <!-- ÂΩìÂâçÁä∂ÊÄÅ -->
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label">ÂΩìÂâçÁ´†ËäÇ</div>
                        <div id="current-chapter" class="status-value">-</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Â∑≤ÂÆåÊàê</div>
                        <div id="completed-chapters" class="status-value text-green-600">0</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Â§±Ë¥•Êï∞</div>
                        <div id="failed-chapters" class="status-value text-red-600">0</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Á¥ØËÆ°ÊàêÊú¨</div>
                        <div id="current-cost" class="status-value text-orange-600">¬•0.00</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Â∑≤Áî®Êó∂Èó¥</div>
                        <div id="elapsed-time" class="status-value">0Áßí</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">ÊàêÂäüÁéá</div>
                        <div id="success-rate" class="status-value">100%</div>
                    </div>
                </div>

                <!-- ÁøªËØëÊó•Âøó -->
                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">üìù ÁøªËØëÊó•Âøó</h3>
                    <div id="translation-log" class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 h-64 overflow-y-auto">
                        <div class="text-gray-500 text-center py-4">Á≠âÂæÖÂºÄÂßãÁøªËØë...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ê≠•È™§4: ÂÆåÊàê -->
        <div id="complete-section" class="section-card hidden">
            <div class="section-header">
                <h2 class="section-title">‚úÖ ÁøªËØëÂÆåÊàê</h2>
            </div>
            <div class="section-content">
                <!-- ÁøªËØëÁªìÊûúÁªüËÆ° -->
                <div id="result-stats" class="info-grid mb-6"></div>

                <!-- ‰øùÂ≠òÊåâÈíÆ -->
                <div class="flex justify-center">
                    <button id="save-chapters-btn" onclick="saveChapters()"
                            class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-lg transition-colors">
                        ‰øùÂ≠òÁ´†ËäÇÂà∞Êï∞ÊçÆÂ∫ì
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ÂÖ®Â±ÄÂèòÈáè
let currentStep = 1;
let selectedFile = null;
let analysisData = null;
let translationTaskId = null;
let progressPollingInterval = null;

// Ê®°ÂºèÂàáÊç¢
function switchMode(mode) {
    const singleTab = document.getElementById('single-mode-tab');
    const batchTab = document.getElementById('batch-mode-tab');
    const singleMode = document.getElementById('single-mode');
    const batchMode = document.getElementById('batch-mode');
    
    if (mode === 'single') {
        singleTab.classList.add('active');
        batchTab.classList.remove('active');
        singleMode.classList.remove('hidden');
        batchMode.classList.add('hidden');
    } else {
        batchTab.classList.add('active');
        singleTab.classList.remove('active');
        batchMode.classList.remove('hidden');
        singleMode.classList.add('hidden');
    }
}

// ËÆæÁΩÆÂΩìÂâçÊ≠•È™§
function setStep(step) {
    currentStep = step;
    
    // Êõ¥Êñ∞Ê≠•È™§ÊåáÁ§∫Âô®
    for (let i = 1; i <= 4; i++) {
        const indicator = document.getElementById(`step-${i}-indicator`);
        indicator.classList.remove('step-active', 'step-completed');
        
        if (i < step) {
            indicator.classList.add('step-completed');
        } else if (i === step) {
            indicator.classList.add('step-active');
        }
    }
}

// Êõ¥Êñ∞Ê≠•È™§ËøõÂ∫¶Êù°
function updateStepProgress(step, percent) {
    const progressBar = document.getElementById(`progress-bar-${step}`);
    if (progressBar) {
        progressBar.style.width = percent + '%';
    }
}

// Â§ÑÁêÜÊñá‰ª∂ÈÄâÊã©
function handleFileSelect(input) {
    const file = input.files[0];
    if (file) {
        selectedFile = file;
        document.getElementById('file-name').textContent = file.name;
        document.getElementById('file-size').textContent = formatFileSize(file.size);
        document.getElementById('file-info').classList.remove('hidden');
        document.getElementById('analyze-btn').disabled = false;
        updateStepProgress(1, 100);
    }
}

// ÂàáÊç¢Ëá™ÂÆö‰πâÊèêÁ§∫ËØç
function toggleCustomPrompt() {
    const useCustom = document.getElementById('use-custom-prompt').checked;
    const customSection = document.getElementById('custom-prompt-section');
    
    if (useCustom) {
        customSection.classList.remove('hidden');
    } else {
        customSection.classList.add('hidden');
    }
}

// ÂºÄÂßãÂàÜÊûê
function startAnalysis() {
    if (!selectedFile) {
        alert('ËØ∑ÂÖàÈÄâÊã©Êñá‰ª∂');
        return;
    }
    
    const apiKey = document.getElementById('api-key').value;
    const customPrompt = document.getElementById('custom-prompt').value;
    const previewMode = document.getElementById('preview-mode').checked;
    
    const formData = new FormData();
    formData.append('novel_file', selectedFile);
    formData.append('api_key', apiKey);
    formData.append('custom_prompt', customPrompt);
    formData.append('preview_mode', previewMode);
    formData.append('novel_id', '{{ novel.id }}');
    
    const analyzeBtn = document.getElementById('analyze-btn');
    analyzeBtn.disabled = true;
    analyzeBtn.textContent = 'ÂàÜÊûê‰∏≠...';
    
    setStep(2);
    updateStepProgress(2, 50);
    
    fetch('/admin/analyze-chapters', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            analysisData = data.data;
            displayAnalysisResult(data.data);
            document.getElementById('translate-btn').disabled = false;
            updateStepProgress(2, 100);
        } else {
            alert('ÂàÜÊûêÂ§±Ë¥•: ' + data.error);
            updateStepProgress(2, 0);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ÂàÜÊûêËøáÁ®ã‰∏≠Âá∫Áé∞ÈîôËØØ');
        updateStepProgress(2, 0);
    })
    .finally(() => {
        analyzeBtn.disabled = false;
        analyzeBtn.textContent = 'ÂºÄÂßãËß£ÊûêÂ∞èËØ¥';
    });
}

// ÊòæÁ§∫ÂàÜÊûêÁªìÊûú
function displayAnalysisResult(data) {
    // Êõ¥Êñ∞Âü∫Êú¨‰ø°ÊÅØ
    document.getElementById('novel-title').textContent = data.title || 'Êú™Áü•';
    document.getElementById('novel-author').textContent = data.author || 'Êú™Áü•';
    document.getElementById('novel-category').textContent = data.category || 'Êú™Áü•';
    document.getElementById('chapter-count').textContent = data.chapter_count || 0;
    document.getElementById('total-words').textContent = formatNumber(data.total_words || 0);
    document.getElementById('estimated-cost').textContent = `¬•${(data.estimated_cost || 0).toFixed(3)}`;
    
    // ÊòæÁ§∫Á´†ËäÇÈ¢ÑËßà
    const chaptersPreview = document.getElementById('chapters-preview');
    chaptersPreview.innerHTML = '';
    
    if (data.preview_chapters && data.preview_chapters.length > 0) {
        data.preview_chapters.forEach((chapter, index) => {
            const chapterDiv = document.createElement('div');
            chapterDiv.className = 'p-4 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg';
            chapterDiv.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-semibold text-gray-900 dark:text-white">${chapter.title}</h4>
                    <span class="text-sm text-gray-500">${chapter.word_count} Â≠ó</span>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400">${chapter.content_preview}</p>
            `;
            chaptersPreview.appendChild(chapterDiv);
        });
    }
    
    // ÊòæÁ§∫Ëß£ÊûêÁªìÊûúÂå∫Âüü
    document.getElementById('parse-section').classList.remove('hidden');
}

// ÂºÄÂßãÁøªËØë
function startTranslation() {
    if (!analysisData) {
        alert('ËØ∑ÂÖàÂàÜÊûêÊñá‰ª∂');
        return;
    }
    
    // Ê∏ÖÁêÜ‰πãÂâçÁöÑËΩÆËØ¢
    if (progressPollingInterval) {
        clearInterval(progressPollingInterval);
        progressPollingInterval = null;
    }
    // Ê≥®ÊÑèÔºö‰∏çË¶ÅÂú®ËøôÈáåÊ∏ÖÁêÜtranslationTaskIdÔºåÂõ†‰∏∫ËΩÆËØ¢ÈúÄË¶ÅÂÆÉ
    
    const customPrompt = document.getElementById('custom-prompt').value;
    const previewMode = document.getElementById('preview-mode').checked;
    
    const requestData = {
        analysis_id: analysisData.analysis_id,
        custom_prompt: customPrompt,
        preview_mode: previewMode,
        novel_id: '{{ novel.id }}'
    };
    
    const translateBtn = document.getElementById('translate-btn');
    translateBtn.disabled = true;
    translateBtn.textContent = 'ÁøªËØë‰∏≠...';
    
    // ÈáçÁΩÆËøõÂ∫¶ÊòæÁ§∫
    document.getElementById('progress-bar').style.width = '0%';
    document.getElementById('progress-percent').textContent = '0%';
    document.getElementById('progress-text').textContent = 'ÂáÜÂ§áÂºÄÂßã...';
    document.getElementById('current-chapter').textContent = '-';
    document.getElementById('completed-chapters').textContent = '0';
    document.getElementById('failed-chapters').textContent = '0';
    document.getElementById('current-cost').textContent = '¬•0.00';
    document.getElementById('elapsed-time').textContent = '0Áßí';
    document.getElementById('success-rate').textContent = '100%';
    
    // Ê∏ÖÁ©∫Êó•Âøó
    const logContainer = document.getElementById('translation-log');
    logContainer.innerHTML = '<div class="text-gray-500 text-center py-4">Á≠âÂæÖÂºÄÂßãÁøªËØë...</div>';
    
    // ÊòæÁ§∫ÁøªËØëËøõÂ∫¶Âå∫Âüü
    setStep(3);
    updateStepProgress(3, 0);
    document.getElementById('translate-section').classList.remove('hidden');
    
    fetch('/admin/translate-chapters', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            translationTaskId = data.task_id;
            startProgressPolling();
        } else {
            console.error('ÁøªËØëÂêØÂä®Â§±Ë¥•:', data.error);
            alert('ÁøªËØëÂêØÂä®Â§±Ë¥•: ' + data.error);
            // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
            translateBtn.disabled = false;
            translateBtn.textContent = 'ÂºÄÂßãÁøªËØëÁ´†ËäÇ';
            // ÈöêËóèÁøªËØëËøõÂ∫¶Âå∫Âüü
            document.getElementById('translate-section').classList.add('hidden');
            setStep(2);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ÁøªËØëËøáÁ®ã‰∏≠Âá∫Áé∞ÈîôËØØ');
        // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
        translateBtn.disabled = false;
        translateBtn.textContent = 'ÂºÄÂßãÁøªËØëÁ´†ËäÇ';
        // ÈöêËóèÁøªËØëËøõÂ∫¶Âå∫Âüü
        document.getElementById('translate-section').classList.add('hidden');
        setStep(2);
    });
}

// ÂºÄÂßãËøõÂ∫¶ËΩÆËØ¢
function startProgressPolling() {
    if (progressPollingInterval) {
        clearInterval(progressPollingInterval);
        progressPollingInterval = null;
    }
    
    if (!translationTaskId) {
        console.error('ÈîôËØØÔºöÊ≤°Êúâtask_idÔºåÊó†Ê≥ïÂºÄÂßãËΩÆËØ¢');
        return;
    }
    
    progressPollingInterval = setInterval(() => {
        if (!translationTaskId) {
            console.log('translationTaskId‰∏∫Á©∫ÔºåÂÅúÊ≠¢ËΩÆËØ¢');
            clearInterval(progressPollingInterval);
            progressPollingInterval = null;
            return;
        }
        
        fetch(`/admin/chapter-translation-progress/${translationTaskId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                console.log('Êî∂Âà∞ËøõÂ∫¶Êï∞ÊçÆ:', {
                    status: data.status,
                    current_chapter: data.progress?.current_chapter,
                    total_chapters: data.progress?.total_chapters,
                    progress_percent: data.progress?.progress_percent
                });
                
                updateProgress(data);
                
                // Ê£ÄÊü•ÂÆåÊàêÊù°‰ª∂ÔºöÂè™ÊúâÁä∂ÊÄÅ‰∏∫completedÊàñerrorÊó∂ÊâçÂÅúÊ≠¢
                const isCompleted = data.status === 'completed' || data.status === 'error';
                
                if (isCompleted) {
                    console.log('ÁøªËØëÂÆåÊàêÔºåÂÅúÊ≠¢ËΩÆËØ¢:', {
                        status: data.status,
                        isCompleted,
                        current_chapter: data.progress?.current_chapter,
                        total_chapters: data.progress?.total_chapters
                    });
                    
                    // Á´ãÂç≥ÂÅúÊ≠¢ËΩÆËØ¢
                    if (progressPollingInterval) {
                        clearInterval(progressPollingInterval);
                        progressPollingInterval = null;
                    }
                    handleTranslationComplete(data);
                }
            } else {
                console.error('Progress polling failed:', data.error);
                // Â¶ÇÊûúËØ∑Ê±ÇÂ§±Ë¥•Ôºå‰πüÂÅúÊ≠¢ËΩÆËØ¢
                if (progressPollingInterval) {
                    clearInterval(progressPollingInterval);
                    progressPollingInterval = null;
                }
            }
        })
        .catch(error => {
            console.error('Progress polling error:', error);
            // ÁΩëÁªúÈîôËØØÊó∂‰πüÂÅúÊ≠¢ËΩÆËØ¢
            if (progressPollingInterval) {
                clearInterval(progressPollingInterval);
                progressPollingInterval = null;
            }
        });
    }, 1000); // ÂáèÂ∞ëËΩÆËØ¢Èó¥ÈöîÂà∞1Áßí
}

// Êõ¥Êñ∞ËøõÂ∫¶
function updateProgress(data) {
    // Ê£ÄÊü•Êï∞ÊçÆÁªìÊûÑÊòØÂê¶ÊúâÊïà
    if (!data || !data.progress) {
        console.warn('ËøõÂ∫¶Êï∞ÊçÆÊó†Êïà:', data);
        return;
    }
    
    const progress = data.progress;
    
    // Êõ¥Êñ∞ËøõÂ∫¶Êù°
    const percent = progress.progress_percent || 0;
    document.getElementById('progress-bar').style.width = percent + '%';
    document.getElementById('progress-percent').textContent = percent.toFixed(1) + '%';
    updateStepProgress(3, percent);
    
    // Êõ¥Êñ∞Áä∂ÊÄÅ‰ø°ÊÅØÔºà‰∏énovel_translator.html‰øùÊåÅ‰∏ÄËá¥Ôºâ
    document.getElementById('current-chapter').textContent = progress.current_chapter_title || '-';
    document.getElementById('completed-chapters').textContent = progress.success_count || 0;
    document.getElementById('failed-chapters').textContent = progress.error_count || 0;
    document.getElementById('current-cost').textContent = '¬•' + (progress.estimated_cost || 0).toFixed(3);
    document.getElementById('elapsed-time').textContent = formatTime(progress.elapsed_time || 0);
    document.getElementById('success-rate').textContent = (progress.success_rate || 100).toFixed(1) + '%';
    
    // Êõ¥Êñ∞ËøõÂ∫¶ÊñáÊú¨
    let progressText;
    if (data.status === 'completed') {
        progressText = `ÁøªËØëÂÆåÊàêÔºÅÂÖ± ${progress.total_chapters} Á´†`;
    } else if (progress.current_chapter >= progress.total_chapters) {
        progressText = `ÁøªËØëÂÆåÊàêÔºÅÂÖ± ${progress.total_chapters} Á´†`;
    } else {
        progressText = `Ê≠£Âú®ÁøªËØëÁ¨¨ ${progress.current_chapter}/${progress.total_chapters} Á´†`;
    }
    document.getElementById('progress-text').textContent = progressText;
    
    // Ê∑ªÂä†Êó•Âøó
    if (data.log_message) {
        addLogEntry(data.log_message, data.log_level || 'info');
    }
}

// Â§ÑÁêÜÁøªËØëÂÆåÊàê
function handleTranslationComplete(data) {
    // Á°Æ‰øùËΩÆËØ¢Â∑≤ÂÅúÊ≠¢
    if (progressPollingInterval) {
        clearInterval(progressPollingInterval);
        progressPollingInterval = null;
    }
    
    if (data.status === 'completed' && data.result) {
        // ‰øùÂ≠òÁøªËØëÁªìÊûúÂà∞analysisData
        analysisData.translated_chapters = data.result.chapters;
        
        // ÊòæÁ§∫ÂÆåÊàêÁªüËÆ°
        displayCompletionStats(data);
        
        // ÊòæÁ§∫ÂÆåÊàêÂå∫ÂüüÔºåÈöêËóèÁøªËØëËøõÂ∫¶Âå∫Âüü
        document.getElementById('translate-section').classList.add('hidden');
        document.getElementById('complete-section').classList.remove('hidden');
        setStep(4);
        updateStepProgress(4, 100);
        
        addLogEntry('ÁøªËØëÂÆåÊàêÔºÅ', 'success');
        
        // Ê∏ÖÁêÜ‰ªªÂä°ID
        translationTaskId = null;
    } else {
        // ÁøªËØëÂ§±Ë¥•Êó∂ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
        const translateBtn = document.getElementById('translate-btn');
        translateBtn.disabled = false;
        translateBtn.textContent = 'ÂºÄÂßãÁøªËØëÁ´†ËäÇ';
        
        // ÈöêËóèÁøªËØëËøõÂ∫¶Âå∫Âüü
        document.getElementById('translate-section').classList.add('hidden');
        setStep(2);
        
        addLogEntry('ÁøªËØëÂ§±Ë¥•: ' + (data.error || 'Êú™Áü•ÈîôËØØ'), 'error');
        translationTaskId = null;
    }
}

// ÊòæÁ§∫ÂÆåÊàêÁªüËÆ°
function displayCompletionStats(data) {
    const resultStats = document.getElementById('result-stats');
    const stats = data.stats || {};
    
    // ËÆ°ÁÆóÊÄªÂ≠óÊï∞
    const totalWords = data.result.chapters.reduce((sum, chapter) => {
        return sum + (chapter.content ? chapter.content.length : 0);
    }, 0);
    
    resultStats.innerHTML = `
        <div class="info-item">
            <div class="info-label">Á´†ËäÇÊï∞</div>
            <div class="info-value">${data.result.chapters.length}</div>
        </div>
        <div class="info-item">
            <div class="info-label">ÊÄªÂ≠óÊï∞</div>
            <div class="info-value">${formatNumber(totalWords)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">ÊàêÂäüÁøªËØë</div>
            <div class="info-value text-green-600">${stats.success_count || 0}</div>
        </div>
        <div class="info-item">
            <div class="info-label">ÁøªËØëÂ§±Ë¥•</div>
            <div class="info-value text-red-600">${stats.error_count || 0}</div>
        </div>
        <div class="info-item">
            <div class="info-label">ÊÄªÊàêÊú¨</div>
            <div class="info-value text-orange-600">¬•${(stats.total_cost || 0).toFixed(3)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">ËÄóÊó∂</div>
            <div class="info-value">${formatTime(stats.elapsed_time || 0)}</div>
        </div>
    `;
}

// ‰øùÂ≠òÁ´†ËäÇ
function saveChapters() {
    if (!analysisData || !analysisData.translated_chapters) {
        alert('Ê≤°ÊúâÂèØ‰øùÂ≠òÁöÑÁøªËØëÁªìÊûú');
        return;
    }
    
    const requestData = {
        novel_id: '{{ novel.id }}',
        chapters: analysisData.translated_chapters
    };
    
    const saveBtn = document.getElementById('save-chapters-btn');
    saveBtn.disabled = true;
    saveBtn.textContent = '‰øùÂ≠ò‰∏≠...';
    
    fetch('/admin/save-translated-chapters', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`ÊàêÂäü‰øùÂ≠ò ${data.chapters_saved} ‰∏™Á´†ËäÇÔºÅ`);
            // Ë∑≥ËΩ¨Âà∞ÁÆ°ÁêÜÈ°µÈù¢
            window.location.href = '/admin';
        } else {
            alert('‰øùÂ≠òÂ§±Ë¥•: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‰øùÂ≠òËøáÁ®ã‰∏≠Âá∫Áé∞ÈîôËØØ');
    })
    .finally(() => {
        saveBtn.disabled = false;
        saveBtn.textContent = '‰øùÂ≠òÁ´†ËäÇÂà∞Êï∞ÊçÆÂ∫ì';
    });
}

// Ê∑ªÂä†Êó•ÂøóÊù°ÁõÆ
function addLogEntry(message, level = 'info') {
    const logContainer = document.getElementById('translation-log');
    const time = new Date().toLocaleTimeString();
    
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry log-${level}`;
    logEntry.innerHTML = `[${time}] ${message}`;
    
    // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÊù°Êó•ÂøóÔºåÊ∏ÖÁ©∫Âç†‰ΩçÁ¨¶
    if (logContainer.querySelector('.text-center')) {
        logContainer.innerHTML = '';
    }
    
    logContainer.appendChild(logEntry);
    logContainer.scrollTop = logContainer.scrollHeight;
}

// Â∑•ÂÖ∑ÂáΩÊï∞
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function formatTime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (hours > 0) {
        return `${hours}Êó∂${minutes}ÂàÜ${secs}Áßí`;
    } else if (minutes > 0) {
        return `${minutes}ÂàÜ${secs}Áßí`;
    } else {
        return `${secs}Áßí`;
    }
}

// È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÁöÑÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', function() {
    // ÂàùÂßãÂåñÊ≠•È™§ÊåáÁ§∫Âô®
    setStep(1);
    
    // Ê∑ªÂä†ÊãñÊãΩÊîØÊåÅ
    const uploadZone = document.getElementById('upload-zone');
    
    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });
    
    uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
    });
    
    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const fileInput = document.getElementById('novel-file');
            fileInput.files = files;
            handleFileSelect(fileInput);
        }
    });
});

// È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜËΩÆËØ¢
window.addEventListener('beforeunload', function() {
    if (progressPollingInterval) {
        clearInterval(progressPollingInterval);
        progressPollingInterval = null;
    }
});

// È°µÈù¢ÈöêËóèÊó∂‰πüÊ∏ÖÁêÜËΩÆËØ¢ÔºàÈò≤Ê≠¢ÂêéÂè∞ÁªßÁª≠ËØ∑Ê±ÇÔºâ
document.addEventListener('visibilitychange', function() {
    if (document.hidden && progressPollingInterval) {
        clearInterval(progressPollingInterval);
        progressPollingInterval = null;
        console.log('È°µÈù¢ÈöêËóèÔºåÂ∑≤ÂÅúÊ≠¢ËøõÂ∫¶ËΩÆËØ¢');
    }
});
</script>
{% endblock %}