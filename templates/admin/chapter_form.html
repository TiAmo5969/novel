{% extends 'base.html' %}
{% block title %}{{ title }}{% endblock %}

{% block head %}
<style>
    .section-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        margin-bottom: 24px;
        overflow: hidden;
    }

    .dark .section-card {
        background: #1f2937;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    }

    .section-header {
        padding: 24px 24px 0 24px;
    }

    .section-title {
        font-size: 20px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 8px;
    }

    .dark .section-title {
        color: #f9fafb;
    }

    .section-content {
        padding: 24px;
    }

    .upload-zone {
        border: 2px dashed #d1d5db;
        border-radius: 12px;
        padding: 48px 24px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .upload-zone:hover {
        border-color: #3b82f6;
        background: #f8fafc;
    }

    .dark .upload-zone {
        border-color: #4b5563;
        background: #374151;
    }

    .dark .upload-zone:hover {
        border-color: #3b82f6;
        background: #4b5563;
    }

    .upload-icon {
        width: 48px;
        height: 48px;
        color: #9ca3af;
        margin: 0 auto 16px;
    }

    .upload-text {
        color: #6b7280;
    }

    .dark .upload-text {
        color: #9ca3af;
    }

    .upload-main-text {
        font-size: 18px;
        font-weight: 500;
        margin-bottom: 4px;
    }

    .upload-sub-text {
        font-size: 14px;
    }

    .config-card {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 20px;
    }

    .dark .config-card {
        background: #374151;
        border-color: #4b5563;
    }

    .config-title {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 16px;
    }

    .dark .config-title {
        color: #f9fafb;
    }

    .step-indicator {
        display: flex;
        flex-direction: column;
        align-items: center;
        opacity: 0.5;
        transition: all 0.3s ease;
    }

    .step-indicator.step-active {
        opacity: 1;
    }

    .step-indicator.step-completed {
        opacity: 1;
        color: #10b981;
    }

    .step-number {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
        color: #6b7280;
        margin-bottom: 8px;
    }

    .step-indicator.step-active .step-number {
        background: #3b82f6;
        color: white;
    }

    .step-indicator.step-completed .step-number {
        background: #10b981;
        color: white;
    }

    .step-label {
        font-size: 12px;
        font-weight: 500;
        text-align: center;
        color: #6b7280;
    }

    .step-indicator.step-active .step-label {
        color: #3b82f6;
    }

    .step-indicator.step-completed .step-label {
        color: #10b981;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .info-item {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
    }

    .dark .info-item {
        background: #374151;
        border-color: #4b5563;
    }

    .info-label {
        font-size: 12px;
        font-weight: 500;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 4px;
    }

    .info-value {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
    }

    .dark .info-value {
        color: #f9fafb;
    }

    .log-entry {
        padding: 8px 12px;
        margin-bottom: 4px;
        border-radius: 6px;
        font-size: 14px;
        font-family: 'Courier New', monospace;
    }

    .log-info {
        background: #eff6ff;
        color: #1e40af;
        border-left: 3px solid #3b82f6;
    }

    .dark .log-info {
        background: #1e3a8a;
        color: #93c5fd;
    }

    .log-success {
        background: #f0fdf4;
        color: #166534;
        border-left: 3px solid #10b981;
    }

    .dark .log-success {
        background: #064e3b;
        color: #6ee7b7;
    }

    .log-error {
        background: #fef2f2;
        color: #dc2626;
        border-left: 3px solid #ef4444;
    }

    .dark .log-error {
        background: #7f1d1d;
        color: #fca5a5;
    }

    .mode-tabs {
        display: flex;
        background: #f3f4f6;
        border-radius: 8px;
        padding: 4px;
        margin-bottom: 24px;
    }

    .dark .mode-tabs {
        background: #374151;
    }

    .mode-tab {
        flex: 1;
        padding: 12px 24px;
        text-align: center;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        color: #6b7280;
    }

    .dark .mode-tab {
        color: #9ca3af;
    }

    .mode-tab.active {
        background: white;
        color: #1f2937;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .dark     .mode-tab.active {
        background: #1f2937;
        color: #f9fafb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .status-item {
        text-align: center;
        padding: 16px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
    }

    .dark .status-item {
        background: #374151;
        border-color: #4b5563;
    }

    .status-label {
        font-size: 12px;
        font-weight: 500;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 4px;
    }

    .dark .status-label {
        color: #9ca3af;
    }

    .status-value {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
    }

    .dark .status-value {
        color: #f9fafb;
    }

    .progress-card {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
    }

    .dark .progress-card {
        background: #374151;
        border-color: #4b5563;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
            ğŸ“– {{ title }} - {{ novel.title }}
        </h1>
        <p class="text-gray-600 dark:text-gray-400">
            ä¸ºå°è¯´ã€Š{{ novel.title }}ã€‹æ·»åŠ ç« èŠ‚ï¼Œæ”¯æŒå•ç« èŠ‚æ·»åŠ æˆ–æ‰¹é‡ç¿»è¯‘æ·»åŠ 
        </p>
    </div>

    <!-- æ¨¡å¼é€‰æ‹©æ ‡ç­¾ -->
    <div class="mode-tabs">
        <div class="mode-tab active" id="single-mode-tab" onclick="switchMode('single')">
            ğŸ“ å•ç« èŠ‚æ·»åŠ 
        </div>
        <div class="mode-tab" id="batch-mode-tab" onclick="switchMode('batch')">
            ğŸ”„ æ‰¹é‡ç¿»è¯‘æ·»åŠ 
        </div>
    </div>

    <!-- å•ç« èŠ‚æ·»åŠ æ¨¡å¼ -->
    <div id="single-mode" class="mode-content">
        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">ğŸ“ å•ç« èŠ‚æ·»åŠ </h2>
            </div>
            <div class="section-content">
                <form method="POST" id="single-form">
                    {{ form.hidden_tag() }}
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                ç« èŠ‚æ ‡é¢˜ <span class="text-red-500">*</span>
                            </label>
                            {{ form.title(class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent") }}
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                ç« èŠ‚å†…å®¹ <span class="text-red-500">*</span>
                            </label>
                            {{ form.content(class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent", rows="10") }}
                        </div>
                        <div class="flex justify-end">
                            {{ form.submit(class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors") }}
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡ç¿»è¯‘æ·»åŠ æ¨¡å¼ -->
    <div id="batch-mode" class="mode-content hidden">
        <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
        <div class="mb-8">
            <div class="flex items-center justify-between relative">
                <div class="flex items-center">
                    <div id="step-1-indicator" class="step-indicator step-active">
                        <div class="step-number">1</div>
                        <div class="step-label">ä¸Šä¼ æ–‡ä»¶</div>
                    </div>
                </div>
                
                <div class="flex-1 h-1 bg-gray-200 dark:bg-gray-700 mx-4">
                    <div id="progress-bar-1" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                </div>
                
                <div class="flex items-center">
                    <div id="step-2-indicator" class="step-indicator">
                        <div class="step-number">2</div>
                        <div class="step-label">è§£æç« èŠ‚</div>
                    </div>
                </div>
                
                <div class="flex-1 h-1 bg-gray-200 dark:bg-gray-700 mx-4">
                    <div id="progress-bar-2" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                </div>
                
                <div class="flex items-center">
                    <div id="step-3-indicator" class="step-indicator">
                        <div class="step-number">3</div>
                        <div class="step-label">AIç¿»è¯‘</div>
                    </div>
                </div>
                
                <div class="flex-1 h-1 bg-gray-200 dark:bg-gray-700 mx-4">
                    <div id="progress-bar-3" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                </div>
                
                <div class="flex items-center">
                    <div id="step-4-indicator" class="step-indicator">
                        <div class="step-number">4</div>
                        <div class="step-label">å®Œæˆ</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ­¥éª¤1: æ–‡ä»¶ä¸Šä¼  -->
        <div id="upload-section" class="section-card">
            <div class="section-header">
                <h2 class="section-title">ğŸ“ ä¸Šä¼ ä¸­æ–‡å°è¯´æ–‡ä»¶</h2>
            </div>
            <div class="section-content">
                <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
                <div class="upload-zone" id="upload-zone" onclick="document.getElementById('novel-file').click()">
                    <div class="upload-content">
                        <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <div class="upload-text">
                            <div class="upload-main-text">ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</div>
                            <div class="upload-sub-text">æ”¯æŒ TXT æ ¼å¼ï¼ŒåŒ…å«å¤šç« èŠ‚çš„ä¸­æ–‡å°è¯´</div>
                        </div>
                    </div>
                    <input type="file" id="novel-file" accept=".txt" style="display: none;" onchange="handleFileSelect(this)">
                </div>

                <!-- æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º -->
                <div id="file-info" class="hidden mt-4 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 rounded-lg">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div>
                            <div class="font-medium text-green-800 dark:text-green-200">æ–‡ä»¶å·²é€‰æ‹©</div>
                            <div class="text-sm text-green-600 dark:text-green-300">
                                <span id="file-name"></span> - <span id="file-size"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- é…ç½®åŒºåŸŸ -->
                <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- API Keyé…ç½® -->
                    <div class="config-card">
                        <h3 class="config-title">ğŸ”‘ APIé…ç½®</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    é€šä¹‰åƒé—®API Key
                                </label>
                                <input type="password" id="api-key" 
                                       class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"
                                       placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤APIå¯†é’¥">
                                <div class="text-xs text-gray-500 mt-1">
                                    ğŸ”— <a href="https://dashscope.console.aliyun.com/" target="_blank" class="text-blue-600 underline">è·å–API Key</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ç¿»è¯‘é…ç½® -->
                    <div class="config-card">
                        <h3 class="config-title">âš™ï¸ ç¿»è¯‘é…ç½®</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" id="use-custom-prompt" class="mr-2" onchange="toggleCustomPrompt()">
                                    <span class="font-medium text-gray-700 dark:text-gray-300">ä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯</span>
                                </label>
                            </div>
                            
                            <div id="custom-prompt-section" class="hidden">
                                <textarea id="custom-prompt" 
                                          class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"
                                          rows="3" 
                                          placeholder="è¾“å…¥è‡ªå®šä¹‰ç¿»è¯‘æç¤ºè¯..."></textarea>
                            </div>
                            
                            <div>
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" id="preview-mode" class="mr-2">
                                    <span class="font-medium text-gray-700 dark:text-gray-300">é¢„è§ˆæ¨¡å¼ (åªç¿»è¯‘å‰3ç« )</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å¼€å§‹è§£ææŒ‰é’® -->
                <div class="mt-6">
                    <button id="analyze-btn" onclick="startAnalysis()" disabled
                            class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                        å¼€å§‹è§£æå°è¯´
                    </button>
                </div>
            </div>
        </div>
        
        <!-- æ­¥éª¤2: è§£æç»“æœ -->
        <div id="parse-section" class="section-card hidden">
            <div class="section-header">
                <h2 class="section-title">ğŸ“Š è§£æç»“æœ</h2>
            </div>
            <div class="section-content">
                <!-- å°è¯´åŸºæœ¬ä¿¡æ¯ -->
                <div id="novel-info" class="info-grid">
                    <div class="info-item">
                        <div class="info-label">æ ‡é¢˜</div>
                        <div id="novel-title" class="info-value"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ä½œè€…</div>
                        <div id="novel-author" class="info-value"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">åˆ†ç±»</div>
                        <div id="novel-category" class="info-value"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ç« èŠ‚æ•°</div>
                        <div id="chapter-count" class="info-value"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">æ€»å­—æ•°</div>
                        <div id="total-words" class="info-value"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">é¢„ä¼°æˆæœ¬</div>
                        <div id="estimated-cost" class="info-value text-orange-600"></div>
                    </div>
                </div>

                <!-- ç« èŠ‚é¢„è§ˆ -->
                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">ğŸ“– ç« èŠ‚é¢„è§ˆ</h3>
                    <div id="chapters-preview" class="space-y-3"></div>
                </div>

                <!-- å¼€å§‹ç¿»è¯‘æŒ‰é’® -->
                <div class="mt-6">
                    <button id="translate-btn" onclick="startTranslation()" disabled
                            class="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                        å¼€å§‹ç¿»è¯‘ç« èŠ‚
                    </button>
                </div>
            </div>
        </div>

        <!-- æ­¥éª¤3: ç¿»è¯‘è¿›åº¦ -->
        <div id="translate-section" class="section-card hidden">
            <div class="section-header">
                <h2 class="section-title">ğŸ¤– AIç¿»è¯‘è¿›è¡Œä¸­</h2>
            </div>
            <div class="section-content">
                <!-- æ€»ä½“è¿›åº¦ -->
                <div class="progress-card">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">ç¿»è¯‘è¿›åº¦</span>
                        <span id="progress-percent" class="text-sm font-medium text-blue-600">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                        <div id="progress-bar" class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div class="mt-2 text-xs text-gray-500">
                        <span id="progress-text">å‡†å¤‡å¼€å§‹...</span>
                    </div>
                </div>

                <!-- å½“å‰çŠ¶æ€ -->
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label">å½“å‰ç« èŠ‚</div>
                        <div id="current-chapter" class="status-value">-</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">å·²å®Œæˆ</div>
                        <div id="completed-chapters" class="status-value text-green-600">0</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">å¤±è´¥æ•°</div>
                        <div id="failed-chapters" class="status-value text-red-600">0</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">ç´¯è®¡æˆæœ¬</div>
                        <div id="current-cost" class="status-value text-orange-600">Â¥0.00</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">å·²ç”¨æ—¶é—´</div>
                        <div id="elapsed-time" class="status-value">0ç§’</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">æˆåŠŸç‡</div>
                        <div id="success-rate" class="status-value">100%</div>
                    </div>
                </div>

                <!-- ç¿»è¯‘æ—¥å¿— -->
                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">ğŸ“ ç¿»è¯‘æ—¥å¿—</h3>
                    <div id="translation-log" class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 h-64 overflow-y-auto">
                        <div class="text-gray-500 text-center py-4">ç­‰å¾…å¼€å§‹ç¿»è¯‘...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ­¥éª¤4: å®Œæˆ -->
        <div id="complete-section" class="section-card hidden">
            <div class="section-header">
                <h2 class="section-title">âœ… ç¿»è¯‘å®Œæˆ</h2>
            </div>
            <div class="section-content">
                <!-- ç¿»è¯‘ç»“æœç»Ÿè®¡ -->
                <div id="result-stats" class="info-grid mb-6"></div>

                <!-- ä¿å­˜æŒ‰é’® -->
                <div class="flex justify-center">
                    <button id="save-chapters-btn" onclick="saveChapters()"
                            class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-lg transition-colors">
                        ä¿å­˜ç« èŠ‚åˆ°æ•°æ®åº“
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// å…¨å±€å˜é‡
let currentStep = 1;
let selectedFile = null;
let analysisData = null;
let translationTaskId = null;
let progressPollingInterval = null;

// æ¨¡å¼åˆ‡æ¢
function switchMode(mode) {
    const singleTab = document.getElementById('single-mode-tab');
    const batchTab = document.getElementById('batch-mode-tab');
    const singleMode = document.getElementById('single-mode');
    const batchMode = document.getElementById('batch-mode');
    
    if (mode === 'single') {
        singleTab.classList.add('active');
        batchTab.classList.remove('active');
        singleMode.classList.remove('hidden');
        batchMode.classList.add('hidden');
    } else {
        batchTab.classList.add('active');
        singleTab.classList.remove('active');
        batchMode.classList.remove('hidden');
        singleMode.classList.add('hidden');
    }
}

// è®¾ç½®å½“å‰æ­¥éª¤
function setStep(step) {
    currentStep = step;
    
    // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
    for (let i = 1; i <= 4; i++) {
        const indicator = document.getElementById(`step-${i}-indicator`);
        indicator.classList.remove('step-active', 'step-completed');
        
        if (i < step) {
            indicator.classList.add('step-completed');
        } else if (i === step) {
            indicator.classList.add('step-active');
        }
    }
}

// æ›´æ–°æ­¥éª¤è¿›åº¦æ¡
function updateStepProgress(step, percent) {
    const progressBar = document.getElementById(`progress-bar-${step}`);
    if (progressBar) {
        progressBar.style.width = percent + '%';
    }
}

// å¤„ç†æ–‡ä»¶é€‰æ‹©
function handleFileSelect(input) {
    const file = input.files[0];
    if (file) {
        selectedFile = file;
        document.getElementById('file-name').textContent = file.name;
        document.getElementById('file-size').textContent = formatFileSize(file.size);
        document.getElementById('file-info').classList.remove('hidden');
        document.getElementById('analyze-btn').disabled = false;
        updateStepProgress(1, 100);
    }
}

// åˆ‡æ¢è‡ªå®šä¹‰æç¤ºè¯
function toggleCustomPrompt() {
    const useCustom = document.getElementById('use-custom-prompt').checked;
    const customSection = document.getElementById('custom-prompt-section');
    
    if (useCustom) {
        customSection.classList.remove('hidden');
    } else {
        customSection.classList.add('hidden');
    }
}

// å¼€å§‹åˆ†æ
function startAnalysis() {
    if (!selectedFile) {
        alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
        return;
    }
    
    const apiKey = document.getElementById('api-key').value;
    const customPrompt = document.getElementById('custom-prompt').value;
    const previewMode = document.getElementById('preview-mode').checked;
    
    const formData = new FormData();
    formData.append('novel_file', selectedFile);
    formData.append('api_key', apiKey);
    formData.append('custom_prompt', customPrompt);
    formData.append('preview_mode', previewMode);
    formData.append('novel_id', '{{ novel.id }}');
    
    const analyzeBtn = document.getElementById('analyze-btn');
    analyzeBtn.disabled = true;
    analyzeBtn.textContent = 'åˆ†æä¸­...';
    
    setStep(2);
    updateStepProgress(2, 50);
    
    fetch('/admin/analyze-chapters', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            analysisData = data.data;
            displayAnalysisResult(data.data);
            document.getElementById('translate-btn').disabled = false;
            updateStepProgress(2, 100);
        } else {
            alert('åˆ†æå¤±è´¥: ' + data.error);
            updateStepProgress(2, 0);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('åˆ†æè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯');
        updateStepProgress(2, 0);
    })
    .finally(() => {
        analyzeBtn.disabled = false;
        analyzeBtn.textContent = 'å¼€å§‹è§£æå°è¯´';
    });
}

// æ˜¾ç¤ºåˆ†æç»“æœ
function displayAnalysisResult(data) {
    // æ›´æ–°åŸºæœ¬ä¿¡æ¯
    document.getElementById('novel-title').textContent = data.title || 'æœªçŸ¥';
    document.getElementById('novel-author').textContent = data.author || 'æœªçŸ¥';
    document.getElementById('novel-category').textContent = data.category || 'æœªçŸ¥';
    document.getElementById('chapter-count').textContent = data.chapter_count || 0;
    document.getElementById('total-words').textContent = formatNumber(data.total_words || 0);
    document.getElementById('estimated-cost').textContent = `Â¥${(data.estimated_cost || 0).toFixed(3)}`;
    
    // æ˜¾ç¤ºç« èŠ‚é¢„è§ˆ
    const chaptersPreview = document.getElementById('chapters-preview');
    chaptersPreview.innerHTML = '';
    
    if (data.preview_chapters && data.preview_chapters.length > 0) {
        data.preview_chapters.forEach((chapter, index) => {
            const chapterDiv = document.createElement('div');
            chapterDiv.className = 'p-4 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg';
            chapterDiv.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-semibold text-gray-900 dark:text-white">${chapter.title}</h4>
                    <span class="text-sm text-gray-500">${chapter.word_count} å­—</span>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400">${chapter.content_preview}</p>
            `;
            chaptersPreview.appendChild(chapterDiv);
        });
    }
    
    // æ˜¾ç¤ºè§£æç»“æœåŒºåŸŸ
    document.getElementById('parse-section').classList.remove('hidden');
}

// å¼€å§‹ç¿»è¯‘
function startTranslation() {
    if (!analysisData) {
        alert('è¯·å…ˆåˆ†ææ–‡ä»¶');
        return;
    }
    
    // æ¸…ç†ä¹‹å‰çš„è½®è¯¢
    if (progressPollingInterval) {
        clearInterval(progressPollingInterval);
        progressPollingInterval = null;
    }
    // æ³¨æ„ï¼šä¸è¦åœ¨è¿™é‡Œæ¸…ç†translationTaskIdï¼Œå› ä¸ºè½®è¯¢éœ€è¦å®ƒ
    
    const customPrompt = document.getElementById('custom-prompt').value;
    const previewMode = document.getElementById('preview-mode').checked;
    
    const requestData = {
        analysis_id: analysisData.analysis_id,
        custom_prompt: customPrompt,
        preview_mode: previewMode,
        novel_id: '{{ novel.id }}'
    };
    
    const translateBtn = document.getElementById('translate-btn');
    translateBtn.disabled = true;
    translateBtn.textContent = 'ç¿»è¯‘ä¸­...';
    
    // é‡ç½®è¿›åº¦æ˜¾ç¤º
    document.getElementById('progress-bar').style.width = '0%';
    document.getElementById('progress-percent').textContent = '0%';
    document.getElementById('progress-text').textContent = 'å‡†å¤‡å¼€å§‹...';
    document.getElementById('current-chapter').textContent = '-';
    document.getElementById('completed-chapters').textContent = '0';
    document.getElementById('failed-chapters').textContent = '0';
    document.getElementById('current-cost').textContent = 'Â¥0.00';
    document.getElementById('elapsed-time').textContent = '0ç§’';
    document.getElementById('success-rate').textContent = '100%';
    
    // æ¸…ç©ºæ—¥å¿—
    const logContainer = document.getElementById('translation-log');
    logContainer.innerHTML = '<div class="text-gray-500 text-center py-4">ç­‰å¾…å¼€å§‹ç¿»è¯‘...</div>';
    
    // æ˜¾ç¤ºç¿»è¯‘è¿›åº¦åŒºåŸŸ
    setStep(3);
    updateStepProgress(3, 0);
    document.getElementById('translate-section').classList.remove('hidden');
    
    fetch('/admin/translate-chapters', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            translationTaskId = data.task_id;
            startProgressPolling();
        } else {
            console.error('ç¿»è¯‘å¯åŠ¨å¤±è´¥:', data.error);
            alert('ç¿»è¯‘å¯åŠ¨å¤±è´¥: ' + data.error);
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            translateBtn.disabled = false;
            translateBtn.textContent = 'å¼€å§‹ç¿»è¯‘ç« èŠ‚';
            // éšè—ç¿»è¯‘è¿›åº¦åŒºåŸŸ
            document.getElementById('translate-section').classList.add('hidden');
            setStep(2);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ç¿»è¯‘è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯');
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        translateBtn.disabled = false;
        translateBtn.textContent = 'å¼€å§‹ç¿»è¯‘ç« èŠ‚';
        // éšè—ç¿»è¯‘è¿›åº¦åŒºåŸŸ
        document.getElementById('translate-section').classList.add('hidden');
        setStep(2);
    });
}

// å¼€å§‹è¿›åº¦è½®è¯¢
function startProgressPolling() {
    if (progressPollingInterval) {
        clearInterval(progressPollingInterval);
        progressPollingInterval = null;
    }
    
    if (!translationTaskId) {
        console.error('é”™è¯¯ï¼šæ²¡æœ‰task_idï¼Œæ— æ³•å¼€å§‹è½®è¯¢');
        return;
    }
    
    progressPollingInterval = setInterval(() => {
        if (!translationTaskId) {
            console.log('translationTaskIdä¸ºç©ºï¼Œåœæ­¢è½®è¯¢');
            clearInterval(progressPollingInterval);
            progressPollingInterval = null;
            return;
        }
        
        fetch(`/admin/chapter-translation-progress/${translationTaskId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                console.log('æ”¶åˆ°è¿›åº¦æ•°æ®:', {
                    status: data.status,
                    current_chapter: data.progress?.current_chapter,
                    total_chapters: data.progress?.total_chapters,
                    progress_percent: data.progress?.progress_percent
                });
                
                updateProgress(data);
                
                // æ£€æŸ¥å®Œæˆæ¡ä»¶ï¼šåªæœ‰çŠ¶æ€ä¸ºcompletedæˆ–erroræ—¶æ‰åœæ­¢
                const isCompleted = data.status === 'completed' || data.status === 'error';
                
                if (isCompleted) {
                    console.log('ç¿»è¯‘å®Œæˆï¼Œåœæ­¢è½®è¯¢:', {
                        status: data.status,
                        isCompleted,
                        current_chapter: data.progress?.current_chapter,
                        total_chapters: data.progress?.total_chapters
                    });
                    
                    // ç«‹å³åœæ­¢è½®è¯¢
                    if (progressPollingInterval) {
                        clearInterval(progressPollingInterval);
                        progressPollingInterval = null;
                    }
                    handleTranslationComplete(data);
                }
            } else {
                console.error('Progress polling failed:', data.error);
                // å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œä¹Ÿåœæ­¢è½®è¯¢
                if (progressPollingInterval) {
                    clearInterval(progressPollingInterval);
                    progressPollingInterval = null;
                }
            }
        })
        .catch(error => {
            console.error('Progress polling error:', error);
            // ç½‘ç»œé”™è¯¯æ—¶ä¹Ÿåœæ­¢è½®è¯¢
            if (progressPollingInterval) {
                clearInterval(progressPollingInterval);
                progressPollingInterval = null;
            }
        });
    }, 1000); // å‡å°‘è½®è¯¢é—´éš”åˆ°1ç§’
}

// æ›´æ–°è¿›åº¦
function updateProgress(data) {
    // æ£€æŸ¥æ•°æ®ç»“æ„æ˜¯å¦æœ‰æ•ˆ
    if (!data || !data.progress) {
        console.warn('è¿›åº¦æ•°æ®æ— æ•ˆ:', data);
        return;
    }
    
    const progress = data.progress;
    
    // æ›´æ–°è¿›åº¦æ¡
    const percent = progress.progress_percent || 0;
    document.getElementById('progress-bar').style.width = percent + '%';
    document.getElementById('progress-percent').textContent = percent.toFixed(1) + '%';
    updateStepProgress(3, percent);
    
    // æ›´æ–°çŠ¶æ€ä¿¡æ¯ï¼ˆä¸novel_translator.htmlä¿æŒä¸€è‡´ï¼‰
    document.getElementById('current-chapter').textContent = progress.current_chapter_title || '-';
    document.getElementById('completed-chapters').textContent = progress.success_count || 0;
    document.getElementById('failed-chapters').textContent = progress.error_count || 0;
    document.getElementById('current-cost').textContent = 'Â¥' + (progress.estimated_cost || 0).toFixed(3);
    document.getElementById('elapsed-time').textContent = formatTime(progress.elapsed_time || 0);
    document.getElementById('success-rate').textContent = (progress.success_rate || 100).toFixed(1) + '%';
    
    // æ›´æ–°è¿›åº¦æ–‡æœ¬
    let progressText;
    if (data.status === 'completed') {
        progressText = `ç¿»è¯‘å®Œæˆï¼å…± ${progress.total_chapters} ç« `;
    } else if (progress.current_chapter >= progress.total_chapters) {
        progressText = `ç¿»è¯‘å®Œæˆï¼å…± ${progress.total_chapters} ç« `;
    } else {
        progressText = `æ­£åœ¨ç¿»è¯‘ç¬¬ ${progress.current_chapter}/${progress.total_chapters} ç« `;
    }
    document.getElementById('progress-text').textContent = progressText;
    
    // æ·»åŠ æ—¥å¿—
    if (data.log_message) {
        addLogEntry(data.log_message, data.log_level || 'info');
    }
}

// å¤„ç†ç¿»è¯‘å®Œæˆ
function handleTranslationComplete(data) {
    // ç¡®ä¿è½®è¯¢å·²åœæ­¢
    if (progressPollingInterval) {
        clearInterval(progressPollingInterval);
        progressPollingInterval = null;
    }
    
    if (data.status === 'completed' && data.result) {
        // ä¿å­˜ç¿»è¯‘ç»“æœåˆ°analysisData
        analysisData.translated_chapters = data.result.chapters;
        
        // æ˜¾ç¤ºå®Œæˆç»Ÿè®¡
        displayCompletionStats(data);
        
        // æ˜¾ç¤ºå®ŒæˆåŒºåŸŸï¼Œéšè—ç¿»è¯‘è¿›åº¦åŒºåŸŸ
        document.getElementById('translate-section').classList.add('hidden');
        document.getElementById('complete-section').classList.remove('hidden');
        setStep(4);
        updateStepProgress(4, 100);
        
        addLogEntry('ç¿»è¯‘å®Œæˆï¼', 'success');
        
        // æ¸…ç†ä»»åŠ¡ID
        translationTaskId = null;
    } else {
        // ç¿»è¯‘å¤±è´¥æ—¶æ¢å¤æŒ‰é’®çŠ¶æ€
        const translateBtn = document.getElementById('translate-btn');
        translateBtn.disabled = false;
        translateBtn.textContent = 'å¼€å§‹ç¿»è¯‘ç« èŠ‚';
        
        // éšè—ç¿»è¯‘è¿›åº¦åŒºåŸŸ
        document.getElementById('translate-section').classList.add('hidden');
        setStep(2);
        
        addLogEntry('ç¿»è¯‘å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        translationTaskId = null;
    }
}

// æ˜¾ç¤ºå®Œæˆç»Ÿè®¡
function displayCompletionStats(data) {
    const resultStats = document.getElementById('result-stats');
    const stats = data.stats || {};
    
    // è®¡ç®—æ€»å­—æ•°
    const totalWords = data.result.chapters.reduce((sum, chapter) => {
        return sum + (chapter.content ? chapter.content.length : 0);
    }, 0);
    
    resultStats.innerHTML = `
        <div class="info-item">
            <div class="info-label">ç« èŠ‚æ•°</div>
            <div class="info-value">${data.result.chapters.length}</div>
        </div>
        <div class="info-item">
            <div class="info-label">æ€»å­—æ•°</div>
            <div class="info-value">${formatNumber(totalWords)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">æˆåŠŸç¿»è¯‘</div>
            <div class="info-value text-green-600">${stats.success_count || 0}</div>
        </div>
        <div class="info-item">
            <div class="info-label">ç¿»è¯‘å¤±è´¥</div>
            <div class="info-value text-red-600">${stats.error_count || 0}</div>
        </div>
        <div class="info-item">
            <div class="info-label">æ€»æˆæœ¬</div>
            <div class="info-value text-orange-600">Â¥${(stats.total_cost || 0).toFixed(3)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">è€—æ—¶</div>
            <div class="info-value">${formatTime(stats.elapsed_time || 0)}</div>
        </div>
    `;
}

// ä¿å­˜ç« èŠ‚
function saveChapters() {
    if (!analysisData || !analysisData.translated_chapters) {
        alert('æ²¡æœ‰å¯ä¿å­˜çš„ç¿»è¯‘ç»“æœ');
        return;
    }
    
    const requestData = {
        novel_id: '{{ novel.id }}',
        chapters: analysisData.translated_chapters
    };
    
    const saveBtn = document.getElementById('save-chapters-btn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'ä¿å­˜ä¸­...';
    
    fetch('/admin/save-translated-chapters', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`æˆåŠŸä¿å­˜ ${data.chapters_saved} ä¸ªç« èŠ‚ï¼`);
            // è·³è½¬åˆ°ç®¡ç†é¡µé¢
            window.location.href = '/admin';
        } else {
            alert('ä¿å­˜å¤±è´¥: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ä¿å­˜è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯');
    })
    .finally(() => {
        saveBtn.disabled = false;
        saveBtn.textContent = 'ä¿å­˜ç« èŠ‚åˆ°æ•°æ®åº“';
    });
}

// æ·»åŠ æ—¥å¿—æ¡ç›®
function addLogEntry(message, level = 'info') {
    const logContainer = document.getElementById('translation-log');
    const time = new Date().toLocaleTimeString();
    
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry log-${level}`;
    logEntry.innerHTML = `[${time}] ${message}`;
    
    // å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ—¥å¿—ï¼Œæ¸…ç©ºå ä½ç¬¦
    if (logContainer.querySelector('.text-center')) {
        logContainer.innerHTML = '';
    }
    
    logContainer.appendChild(logEntry);
    logContainer.scrollTop = logContainer.scrollHeight;
}

// å·¥å…·å‡½æ•°
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function formatTime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (hours > 0) {
        return `${hours}æ—¶${minutes}åˆ†${secs}ç§’`;
    } else if (minutes > 0) {
        return `${minutes}åˆ†${secs}ç§’`;
    } else {
        return `${secs}ç§’`;
    }
}

// é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–æ­¥éª¤æŒ‡ç¤ºå™¨
    setStep(1);
    
    // æ·»åŠ æ‹–æ‹½æ”¯æŒ
    const uploadZone = document.getElementById('upload-zone');
    
    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });
    
    uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
    });
    
    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const fileInput = document.getElementById('novel-file');
            fileInput.files = files;
            handleFileSelect(fileInput);
        }
    });
});

// é¡µé¢å¸è½½æ—¶æ¸…ç†è½®è¯¢
window.addEventListener('beforeunload', function() {
    if (progressPollingInterval) {
        clearInterval(progressPollingInterval);
        progressPollingInterval = null;
    }
});

// é¡µé¢éšè—æ—¶ä¹Ÿæ¸…ç†è½®è¯¢ï¼ˆé˜²æ­¢åå°ç»§ç»­è¯·æ±‚ï¼‰
document.addEventListener('visibilitychange', function() {
    if (document.hidden && progressPollingInterval) {
        clearInterval(progressPollingInterval);
        progressPollingInterval = null;
        console.log('é¡µé¢éšè—ï¼Œå·²åœæ­¢è¿›åº¦è½®è¯¢');
    }
});
</script>
{% endblock %}